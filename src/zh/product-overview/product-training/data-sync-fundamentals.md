# 数据同步原理

## Linux Agent

Linux Agent 主要由用户态和内核态模块组成。内核态模块负责捕获 I/O 变化，实时监控文件系统的读写操作；用户态模块则将捕获到的数据通过不同协议传输至目标存储，并管理全量和增量备份的流程。通过内核态和用户态模块的协同工作，Linux Agent 能够高效地执行数据同步和备份任务。

Linux Agent内核模块通过实现写时复制（COW）系统来管理快照并跟踪更改。当首次为块设备初始化时，内核模块会在驱动器上创建一个 COW 数据存储文件。内核模块拦截所有块级写操作，并在写入完成之前将即将被更改的数据复制到快照存储中。通过这种方式，即使写操作正在进行，该模块也可以维护文件系统的完整和一致的快照。快照数据由内核模块通过位于磁盘上 COW 文件开头的索引进行管理和访问。此实现使我们的写时复制系统能够在块级别可靠地维护驱动器的完整时间点镜像，从而比其他方法更稳定和一致。

## Windows Agent

**Windows Agent** 分为两个主要层次：内核态和应用层。

1. **内核态驱动**：负责采集所有被保护磁盘的写入I/O操作，并提供接口供应用层使用。通过两次时间标记，内核驱动能够统计所有写入I/O的序列。
    
2. **应用层**：主要负责读取磁盘块数据并将目标数据写入（如通过iSCSI或OSS）。为提高数据同步效率并解决一致性问题，应用层采用微软的卷影复制服务（VSS）技术，支持创建卷快照并利用写时复制（COW）原理保持快照数据的一致性。
    
3. **快照与同步**：数据同步基于块级别，应用层分析每个被保护磁盘，识别每个卷的起始和结束位置，实现位置映射，从而快速定位读取磁盘的每一块数据。
    
4. **有效数据同步**：应用层仅同步卷中的有效数据。通过读取每个卷的元数据中的位图（bitmap），计算有效和无效数据扇区，系统在数据同步时跳过无效区域，以优化同步过程。

## VMware无代理方式

VMware 无代理方式的数据同步主要通过 VMware 的 Changed Block Tracking (CBT) 技术实现。CBT 是一种高效的虚拟机磁盘变更追踪技术，它能够在增量同步时，识别并捕获自上次同步以来发生变化的磁盘数据块，从而仅同步这些已变更的数据部分，极大提高了备份效率。

通过 vCenter API 或者 ESXi API，系统可以获取主机的元数据信息，如虚拟机配置、磁盘信息和虚拟机运行状态（如电源状态）等。这样，无需在每台主机上安装代理程序，就能够集中管理所有平台中的虚拟机，为后续的数据同步做好准备。

在每次同步之前，为确保磁盘数据的一致性和完整性，系统需要先调用主机的快照接口，创建虚拟机的快照。这一步骤能够确保在同步过程中，磁盘数据保持一致，避免了虚拟机在同步时被修改而导致的同步数据不一致问题。

在增量备份过程中，CBT 机制会标记磁盘中已修改的数据块（Changed Blocks）。通过这种方式，系统能够高效地识别并仅同步这些变化的数据，而无需重新传输整个虚拟机的磁盘内容。这样，不仅节省了带宽和存储空间，还显著减少了备份所需的时间。

## OpenStack Ceph无代理方式

在无代理模式下，基于Ceph存储的OpenStack云平台的数据同步依赖于源端同步代理节点、Ceph存储和OpenStack API接口之间的协作。该同步方式通过增量快照技术，确保数据同步过程高效且带宽利用最大化。以下是该数据同步原理的详细描述：

**注意**：当前该同步模式仅适用于使用Ceph存储并支持RBD连接的OpenStack平台，且OpenStack API未做修改。对于采用商业化存储的OpenStack平台，该模式暂时不支持。

### 1. 源端同步代理节点

源端同步代理节点需要具备以下两种访问能力：

- **OpenStack API接口访问**：用于获取OpenStack虚拟机的状态信息，执行虚拟机实例的快照操作，以及查询虚拟机的其他相关信息。
- **Ceph存储网络访问**：用于读取Ceph存储池中的元数据信息，特别是Ceph快照的增量数据，通过差异比较来识别和同步变化的数据块。

源端同步代理节点通过OpenStack API获取虚拟机的状态信息并触发快照操作。同时，该节点还需要通过Ceph存储网络获取与快照相关的元数据（包括块设备的版本信息、修改时间戳等），以便进行增量数据的比较和同步。

### 2. 快照操作

在增量同步过程中，首先，源端同步代理节点会通过OpenStack API接口对目标虚拟机执行快照操作，生成虚拟机当前状态的完整数据快照。接着，系统通过调用Ceph的RBD接口，获取与该快照关联的Ceph快照元数据信息。通过这些元数据，系统能够识别哪些数据块在上次快照之后发生了变化。

### 3. 差量数据比较

在获取当前快照和上次快照的元数据信息后，系统将对比两者的差异，识别出已发生变化的数据块。差异比较过程基于Ceph增量快照机制，系统通过对比元数据中的版本信息、修改时间戳等特征，精确识别需要同步的数据块。变化的数据块被标识后，源端同步节点将通过Ceph存储网络读取这些数据块的内容，并准备将其同步到目标存储。

### 4. 数据同步至目标存储

一旦变化的数据块被识别，源端同步代理节点将这些差异数据同步到目标存储。通过增量同步的方式，系统仅同步发生变化的数据，显著降低了带宽需求并减少了不必要的存储占用。此策略确保了数据同步的高效性和最小化的资源消耗。

### 5. 快照清理

数据同步完成后，源端同步节点会执行快照清理操作。具体而言，它将删除上一次的快照，并保留当前快照，以便用于下一次的差量数据比较。此操作有助于有效释放存储空间，同时确保同步过程的连续性与一致性，避免了存储的冗余与不必要的资源占用。

## AWS无代理方式

[Deep in AWS Agentless Mode](../../userguide/presales/aws-agentless-mode-cost-calculator.md)